import{R as y}from"./index-Du9qX_j5.js";const a=[];for(let e=0;e<256;++e)a.push((e+256).toString(16).slice(1));function ce(e,t=0){return(a[e[t+0]]+a[e[t+1]]+a[e[t+2]]+a[e[t+3]]+"-"+a[e[t+4]]+a[e[t+5]]+"-"+a[e[t+6]]+a[e[t+7]]+"-"+a[e[t+8]]+a[e[t+9]]+"-"+a[e[t+10]]+a[e[t+11]]+a[e[t+12]]+a[e[t+13]]+a[e[t+14]]+a[e[t+15]]).toLowerCase()}let Q;const se=new Uint8Array(16);function ae(){if(!Q){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Q=crypto.getRandomValues.bind(crypto)}return Q(se)}const le=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),j={randomUUID:le};function fe(e,t,n){e=e||{};const r=e.random??e.rng?.()??ae();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ce(r)}function c(e,t,n){return j.randomUUID&&!e?j.randomUUID():fe(e)}function v(e){const t=Math.random()*100;return[t<=e,t]}function pe(e){return e.stats.body}function M(e,t){return{...e,state:{...e.state,...t}}}function z(e,t){return{...e,stats:{...e.stats,...t}}}function _(e){return{type:"power",success:!1,evade:!1,critical:!1,criticalModifier:1,element:"physical",...e}}function K(e){return{success:!1,successRoll:0,successThreshold:0,critical:!1,criticalRoll:0,criticalThreshold:0,...e}}function R(e,t,n){return{...e,success:t.success&&!n.success,evade:n.success,critical:t.success&&t.critical}}function T(e,t,n){const r=e+n.stats.accuracy,i=v(r),o=t+0,u=v(o);return K({success:i[0],successRoll:i[1],successThreshold:r,critical:u[0],criticalRoll:u[1],criticalThreshold:o})}function E(e){const t=v(e.stats.evasion);return K({success:t[0],successRoll:t[1],successThreshold:e.stats.evasion})}function de(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],i=t.stats[n.defenseStat],o=r/i,u=n.success?1:0,s=n.critical?n.criticalModifier:1;return n.power*o*u*s}return 0}function ge(e,t){return M(e,{damage:t,alive:pe(e)>t?1:0})}function De(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(i=>{const{effect:o,context:u}=i;return o.modifiers(u).map(l=>({ID:c(),effect:o,modifier:l,context:u}))}).sort((i,o)=>i.effect.priority-o.effect.priority).reduce((i,o)=>{const{modifier:u,context:s,effect:l}=o;return u.filter&&!u.filter(i,s)?i:(n.add(l.ID),u.apply(i,s))},{...e}),e.modified=!0,[e,Array.from(n)]}const H={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:c(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>z(e,{body:e.stats.body+10})}],triggers:()=>[]};function Ie(e,t){return e.players.find(i=>i.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function Dt(e,t){const n=e.actors.find(o=>o.ID===t),r=e.players.find(o=>o.ID===n?.playerID),i=r?.activeActorIDs.indexOf(t);return r?.ID&&i!==void 0&&i!==-1?{ID:c(),playerID:r.ID,index:i}:void 0}function It(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function me(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function B(e,t){return e.actors.find(n=>n.ID===t)}function p(e,t){const n=B(e,t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return De(n,r)[0]}function x(e,t,n){const r=p(e,t);if(r)return n(r)}function I(e,t){return{ID:c(),type:t,target:e}}function g(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function ye(e,t,n){return e&&e.validate(t,n)}function ve(e,t){return e?.actions.find(n=>ye(n,t,f({sourceID:e.ID})))}function he(e,t){const n=t.positions.map(r=>Ie(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function be(e,t){return[...e,...t]}function h(e,t){return[...t,...e]}function A(e){const[t,...n]=e;return n}function _e(e,t){return e.sort(t)}const P={ID:c(),name:"Activate",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!g(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>I(n,"targetID")),validate:(e,t)=>t.targetIDs.length===1},resolve:(e,t)=>[ee(t.playerID,t.sourceID,t),t.targetIDs.map(n=>qe(t.playerID,n,t))]};function Ae(e){return{...P,targets:{...P.targets,max:()=>e,validate:(t,n)=>n.targetIDs.length===e}}}function W(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=he(t,n);return e.resolve(t,r).flatMap(i=>i)}function Se(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function Qe(e){e=je(e);const t=W(e.actionQueue[0].action,e,e.actionQueue[0].context),n=h(e.mutationQueue,t),r=A(e.actionQueue);return{...e,actionQueue:r,mutationQueue:n}}function xe(e){if(!e.triggerQueue[0])return e;const t=Se(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=A(e.triggerQueue),r=h(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function we(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=A(e.mutationQueue);return{...e,mutationQueue:r}}function Me(e){switch(e){case"pre":return"start";case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"pre"}}function w(e){if(!e.battle)return e;const t=Me(e.battle.phase);return e={...e,battle:{...e.battle,phase:t}},t==="start"&&(e=D(e,f({}),"onTurnStart")),t==="end"&&(e=D(e,f({}),"onTurnEnd")),e}function Y(e){if(e.triggerQueue.length>0)return xe(e);if(e.mutationQueue.length>0)return we(e);if(e.promptQueue.length>0)return e;const t=Pe(e);return e=t[0],t[1]?e.actionQueue.length>0?Qe(e):e.battle?w(e):e:e}function J(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function mt(e){return e.battle?.phase==="planning"?"pending":J(e)?"running":e.promptQueue.length>0?"pending":"idle"}function Re(e){for(;J(e);)e=Y(e);return e}function f(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function Te(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function Ee(e){return{...e,effect:Te(e.effect)}}function C(e,t){return{...e,combatLog:[...e.combatLog,...t]}}function Ce(e,t,n){const r=h(e.actionQueue,[{ID:c(),action:n,context:t}]);return{...e,actionQueue:r}}function Oe(e,t,n){const r=h(e.promptQueue,[{ID:c(),action:n,context:t}]);return{...e,promptQueue:r}}function Ue(e,t){if(!e.promptQueue[0])return e;const n=W(e.promptQueue[0].action,e,t),r=h(e.mutationQueue,n),i=A(e.promptQueue);return{...e,promptQueue:i,mutationQueue:r}}function D(e,t,n){const i=me(e).filter(u=>u.type===n&&u.validate(e,t)).map(u=>({ID:c(),trigger:u,context:t})),o=be(e.triggerQueue,i);return{...e,triggerQueue:o}}function je(e){const t=_e(e.actionQueue,(n,r)=>{const i=x(e,n.context.sourceID,u=>u.stats.speed)??0;return(x(e,r.context.sourceID,u=>u.stats.speed)??0)-i});return{...e,actionQueue:t}}function O(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function X(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function He(e,t,n){let r=0;e=O(e,t,{filter:o=>t.targetIDs.includes(o.ID),apply:o=>{const u=p(e,t.sourceID),s=p(e,o.ID);if(!u||!s)return o;const l=de(u,s,n);return r+=l,ge(o,o.state.damage+l)}});const i=e.actors.filter(o=>g(e,o.ID)&&!o.state.alive);return r>0&&(e=D(e,t,"onDamage")),i.length>0&&(e=D(e,{...t,targetIDs:i.map(o=>o.ID)},"onDeath")),e}function Pe(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(i=>i.playerID===n.ID&&!n.activeActorIDs.includes(i.ID)&&i.state.alive);if(n.activeActorIDs.some(i=>i===null)&&r.length>0){const i=Math.min(r.length,n.activeActorIDs.filter(o=>o===null).length);e=Oe(e,f({playerID:n.ID}),Ae(i)),t=!1}}),[e,t]}function Le(e,t){const n={apply:(r,i)=>O(r,i,{filter:o=>o.ID===i.sourceID,apply:o=>M(o,t(o.state))})};return{ID:c(),delta:n,context:e}}function Z(e,t){const n={apply:(r,i)=>C(r,[t(r,i)])};return{ID:c(),delta:n,context:e}}function Ne(e,t,n){return{ID:c(),context:t,delta:{apply:r=>O(r,t,{filter:i=>i.ID===e,apply:n})}}}function qe(e,t,n){return{ID:c(),context:n,delta:{apply:r=>{const i=r.players.find(s=>s.ID===e),o=i.activeActorIDs.indexOf(null),u=i.activeActorIDs.indexOf(t);return o===-1?(console.error("NO SPACE"),r):u!==-1?(console.error("ALREADY ACTIVE"),r):(r=X(r,n,{filter:s=>s.ID===e,apply:s=>({...s,activeActorIDs:s.activeActorIDs.map((l,d)=>d===o?t:l)})}),r=C(r,[`Activated ${B(r,t)?.name}`]),r=D(r,n,"onActorActivate"),r)}}}}function ee(e,t,n){return{ID:c(),context:n,delta:{apply:r=>{const o=r.players.find(u=>u.ID===e).activeActorIDs.indexOf(t);return o===-1?(t&&console.error("ACTOR NOT FOUND",t,e,n),r):(r=X(r,n,{filter:u=>u.ID===e,apply:u=>({...u,activeActorIDs:u.activeActorIDs.map((s,l)=>l===o?null:s)})}),r=D(r,n,"onActorDeactivate"),r)}}}}function ke(){return{ID:c(),context:f({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>Ee(n)).filter(n=>n.effect.duration!==0)})}}}function te(e,t){return{ID:c(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:c(),effect:e,context:r}]})}}}function S(e,t,n,r=[]){return{ID:c(),context:e,delta:{apply:(i,o)=>(i=t.reduce((u,s,l)=>He(u,n[l]??o,s),i),i=C(i,r),i)}}}function Fe(e){return{ID:c(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}const Ve={ID:c(),delay:0,duration:1,priority:0,modifiers:H.modifiers,triggers:e=>[{ID:c(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[te(H,e)]}]},L=e=>{let t;const n=new Set,r=(d,U)=>{const m=typeof d=="function"?d(t):d;if(!Object.is(m,t)){const oe=t;t=U??(typeof m!="object"||m===null)?m:Object.assign({},t,m),n.forEach(ue=>ue(t,oe))}},i=()=>t,s={setState:r,getState:i,getInitialState:()=>l,subscribe:d=>(n.add(d),()=>n.delete(d))},l=t=e(r,i,s);return s},ne=(e=>e?L(e):L),Ge=e=>e;function re(e,t=Ge){const n=y.useSyncExternalStore(e.subscribe,y.useCallback(()=>t(e.getState()),[e,t]),y.useCallback(()=>t(e.getInitialState()),[e,t]));return y.useDebugValue(n),n}const N=e=>Symbol.iterator in e,q=e=>"entries"in e,k=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,o]of n)if(!r.has(i)||!Object.is(o,r.get(i)))return!1;return!0},$e=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),o=r.next();for(;!i.done&&!o.done;){if(!Object.is(i.value,o.value))return!1;i=n.next(),o=r.next()}return!!i.done&&!!o.done};function ze(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:N(e)&&N(t)?q(e)&&q(t)?k(e,t):$e(e,t):k({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function ie(e){const t=y.useRef(void 0);return n=>{const r=e(n);return ze(t.current,r)?t.current:t.current=r}}const Ke=_({offenseStat:"intelligence",defenseStat:"intelligence",element:"psy",power:30,criticalModifier:1.5}),Be={ID:c(),name:"Brain Blast",validate:()=>!0,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>I(n,"position")),validate:(e,t)=>0<t.positions.length&&t.positions.length<=2},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=T(100,0,p(e,t.sourceID)),i=E(p(e,n)),o=R(Ke,r,i),u={...t,targetIDs:[n]};return S(u,[o],[u])})]},We={ID:c(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[],validate:()=>!0},resolve:(e,t)=>[te({ID:c(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:c(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>z(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},F=2,V=50,Ye=_({offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5}),Je={ID:c(),name:"Fireball",validate:(e,t)=>!!x(e,t.sourceID,n=>n.state.mana>=V),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>I(n,"position")),max:()=>F,validate:(e,t)=>0<t.positions.length&&t.positions.length<=F},resolve:(e,t)=>{const n=p(e,t.sourceID),r=T(100,0,n);return[Le(t,i=>({mana:i.mana-V})),S(t,t.targetIDs.map(i=>{const o=p(e,i),u=E(o);return R(Ye,r,u)}),t.targetIDs.map(i=>({...t,targetIDs:[i]})))]}},Xe={ID:c(),name:"Heal",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>I(n,"position")),validate:(e,t)=>t.positions.length===1},resolve(e,t){return[Ne(t.targetIDs[0],t,n=>M(n,{damage:Math.max(n.state.damage-20,0)}))]}},Ze={ID:c(),name:"Hot Shots",validate:()=>!0,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>I(n,"position")),validate:(e,t)=>t.positions.length===1},resolve:(e,t)=>{const n=[];let r=v(80);const i=[r[1]];for(;r[0];)n.push(S(t,[_({offenseStat:"reflexes",defenseStat:"reflexes",element:"fire",power:20})],[t])),r=v(80),i.push(r[1]);return n}},et=_({offenseStat:"intelligence",defenseStat:"intelligence",element:"shock",power:10,criticalModifier:1.5}),yt=100,vt=10,tt={ID:c(),name:"Magic Missile",validate:()=>!0,targets:{unique:!1,max:()=>5,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>I(n,"position")),validate:(e,t)=>t.positions.filter(n=>!!n).length===5},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=T(100,0,p(e,t.sourceID)),i=E(p(e,n)),o=R(et,r,i),u={...t,targetIDs:[n]};return S(u,[o],[u])})]},nt=[Je,tt,Be,Xe,We,Ze];function b(e,t,n){return{ID:c(),playerID:t,parentID:void 0,name:e,modified:!1,actions:nt,stats:n,state:{mana:100,damage:0,alive:1}}}const rt={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.map(n=>{const r=e.actors.find(i=>i.ID===n);return ee(r.playerID,n,t)})}]},it={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[Fe(t),Z(t,n=>`Turn ${n.battle?.turn} started`)]}]},ot={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[ke(),Z(t,n=>`Turn ${n.battle?.turn} ended`)]}]},G=b("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),ut=b("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),ct=b("Hank","__player__",{accuracy:0,body:80,evasion:0,health:0,intelligence:100,reflexes:150,speed:150}),st=b("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),at=b("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),$={ID:"__player__",activeActorIDs:[null,null,null]},lt={ID:"__ai__",activeActorIDs:[null,null,null]},ft={players:[lt,$],battle:{turn:0,phase:"pre",effects:[{ID:c(),effect:rt,context:f({})},{ID:c(),effect:it,context:f({})},{ID:c(),effect:ot,context:f({})}]},actors:[G,ut,ct,st,at],effects:[{ID:c(),effect:Ve,context:f({playerID:$.ID,sourceID:G.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:["Combat started"]},pt=ne(e=>({state:ft,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(u=>u.context.sourceID===n.sourceID))return{state:r};r=Ce(r,n,t);const o=r.players.reduce((u,s)=>u+s.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===o&&(r=w(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=Ue(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:Y(t)}))},flush:()=>{e(({state:t})=>({state:Re(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...w(t),promptQueue:[]}}))}}));function ht(e){return re(pt,ie(e))}const dt=ne((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const i=t().playerID,o=n.actors.find(u=>u&&u.playerID===i&&g(n,u.ID)&&!n.actionQueue.find(s=>s.context.sourceID===u.ID));o&&e({activeActorID:o.ID,activeActionID:ve(o,n)?.ID,stagingContext:void 0})}}));function bt(e){return re(dt,ie(e))}export{Je as F,tt as M,P as S,bt as a,Dt as b,p as c,Ye as d,F as e,vt as f,pe as g,et as h,yt as i,mt as j,ve as n,It as p,ht as u,De as w};
