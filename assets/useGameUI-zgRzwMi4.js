import{R as h}from"./index-DNSA7bmv.js";const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function ae(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let R;const le=new Uint8Array(16);function fe(){if(!R){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");R=crypto.getRandomValues.bind(crypto)}return R(le)}const pe=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),j={randomUUID:pe};function de(e,t,n){e=e||{};const r=e.random??e.rng?.()??fe();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ae(r)}function c(e,t,n){return j.randomUUID&&!e?j.randomUUID():de(e)}function b(e){const t=Math.random()*100;return[t<=e,t]}function De(e){return e.stats.body}function M(e,t){return{...e,state:{...e.state,...t}}}function W(e,t){return{...e,stats:{...e.stats,...t}}}function Q(e){return{type:"power",success:!1,evade:!1,critical:!1,criticalModifier:1,element:"physical",...e}}function Y(e){return{success:!1,successRoll:0,successThreshold:0,critical:!1,criticalRoll:0,criticalThreshold:0,...e}}function E(e,t,n){return{...e,success:t.success,evade:n.success,critical:t.success&&t.critical}}function C(e,t,n){const r=e+n.stats.accuracy,o=b(r),i=t+0,u=b(i);return Y({success:o[0],successRoll:o[1],successThreshold:r,critical:u[0],criticalRoll:u[1],criticalThreshold:i})}function O(e){const t=b(e.stats.evasion);return Y({success:t[0],successRoll:t[1],successThreshold:e.stats.evasion})}function ge(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],o=t.stats[n.defenseStat],i=r/o,u=n.success?1:0,s=n.critical?n.criticalModifier:1,a=n.evade?0:1;return Math.round(n.power*i*u*s*a)}return 0}function Ie(e,t){return M(e,{damage:t,alive:De(e)>t?1:0})}function me(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(o=>{const{effect:i,context:u}=o;return i.modifiers(u).map(a=>({ID:c(),effect:i,modifier:a,context:u}))}).sort((o,i)=>o.effect.priority-i.effect.priority).reduce((o,i)=>{const{modifier:u,context:s,effect:a}=i;return u.filter&&!u.filter(o,s)?o:(n.add(a.ID),u.apply(o,s))},{...e}),e.modified=!0,[e,Array.from(n)]}const H={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:c(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>W(e,{body:e.stats.body+10})}],triggers:()=>[]};function ye(e,t){return e.players.find(o=>o.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function vt(e,t){const n=e.actors.find(i=>i.ID===t),r=e.players.find(i=>i.ID===n?.playerID),o=r?.activeActorIDs.indexOf(t);return r?.ID&&o!==void 0&&o!==-1?{ID:c(),playerID:r.ID,index:o}:void 0}function ht(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function ve(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function P(e,t){return e.actors.find(n=>n.ID===t)}function p(e,t){const n=P(e,t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return me(n,r)[0]}function A(e,t,n){const r=p(e,t);if(r)return n(r)}function y(e,t){return{ID:c(),type:t,target:e}}function g(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function he(e,t,n){return e&&e.validate(t,n)}function be(e,t){return e?.actions.find(n=>he(n,t,d({sourceID:e.ID})))}function Se(e,t){const n=t.positions.map(r=>ye(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function _e(e,t){return[...e,...t]}function S(e,t){return[...t,...e]}function w(e){const[t,...n]=e;return n}function Ae(e,t){return e.sort(t)}const L={ID:c(),name:"Activate",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!g(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>y(n,"targetID")),validate:(e,t)=>t.targetIDs.length===1},resolve:(e,t)=>[ne(t.playerID,t.sourceID,t),t.targetIDs.map(n=>Fe(t.playerID,n,t))]};function Qe(e){return{...L,targets:{...L.targets,max:()=>e,validate:(t,n)=>n.targetIDs.length===e}}}function J(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=Se(t,n);return e.resolve(t,r).flatMap(o=>o)}function we(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function xe(e){e=je(e);const t=e.actionQueue[0];e=I(e,[`${A(e,t.context.sourceID,i=>i.name)} uses ${t.action.name}.`]);const n=J(t.action,e,t.context),r=S(e.mutationQueue,n),o=w(e.actionQueue);return{...e,actionQueue:o,mutationQueue:r}}function Re(e){if(!e.triggerQueue[0])return e;const t=we(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=w(e.triggerQueue),r=S(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function Te(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=w(e.mutationQueue);return{...e,mutationQueue:r}}function Me(e){switch(e){case"pre":return"start";case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"pre"}}function T(e){if(!e.battle)return e;const t=Me(e.battle.phase);return e=te(e,t),t==="start"&&(e=m(e,d({}),"onTurnStart")),t==="end"&&(e=m(e,d({}),"onTurnEnd")),e}function X(e){if(e.triggerQueue.length>0)return Re(e);if(e.mutationQueue.length>0)return Te(e);if(e.promptQueue.length>0)return e;const t=ke(e);return e=t[0],t[1]?e.actionQueue.length>0?xe(e):e.battle?T(e):e:e}function Z(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function bt(e){return e.battle?.phase==="planning"?"pending":Z(e)?"running":e.promptQueue.length>0?"pending":"idle"}function Ee(e){for(;Z(e);)e=X(e);return e}function d(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function Ce(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function Oe(e){return{...e,effect:Ce(e.effect)}}function I(e,t){return{...e,combatLog:[...e.combatLog,...t]}}function Pe(e,t,n){const r=S(e.actionQueue,[{ID:c(),action:n,context:t}]);return{...e,actionQueue:r}}function Ue(e,t,n){const r=S(e.promptQueue,[{ID:c(),action:n,context:t}]);return{...e,promptQueue:r}}function Ne(e,t){if(!e.promptQueue[0])return e;const n=J(e.promptQueue[0].action,e,t),r=S(e.mutationQueue,n),o=w(e.promptQueue);return{...e,promptQueue:o,mutationQueue:r}}function m(e,t,n){const o=ve(e).filter(u=>u.type===n&&u.validate(e,t)).map(u=>({ID:c(),trigger:u,context:t})),i=_e(e.triggerQueue,o);return{...e,triggerQueue:i}}function je(e){const t=Ae(e.actionQueue,(n,r)=>{const o=A(e,n.context.sourceID,u=>u.stats.speed)??0;return(A(e,r.context.sourceID,u=>u.stats.speed)??0)-o});return{...e,actionQueue:t}}function He(e,t){const n=e.actionQueue.filter(r=>r.context.sourceID!==t);return console.log("filtering action queue",t),console.log(e.actionQueue),console.log(n),{...e,actionQueue:n}}function U(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function ee(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function Le(e,t,n){let r=0;e=U(e,t,{filter:s=>t.targetIDs.includes(s.ID),apply:s=>{const a=p(e,t.sourceID),f=p(e,s.ID);if(!a||!f)return s;const D=ge(a,f,n);return r+=D,Ie(s,s.state.damage+D)}});const o=t.targetIDs[0],i=P(e,o),u=g(e,o)&&!i?.state.alive;return r>0&&(e=m(e,t,"onDamage"),e=I(e,[`${i?.name} took ${r} damage.`])),u&&(e=m(e,t,"onDeath")),e}function te(e,t){return e.battle?{...e,battle:{...e.battle,phase:t}}:e}function ke(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(o=>o.playerID===n.ID&&!n.activeActorIDs.includes(o.ID)&&o.state.alive);if(n.activeActorIDs.some(o=>o===null)&&r.length>0){const o=Math.min(r.length,n.activeActorIDs.filter(i=>i===null).length);e=Ue(e,d({playerID:n.ID}),Qe(o)),t=!1}n.activeActorIDs.every(o=>o===null)&&r.length===0&&(e=te(e,"post"),t=!1)}),[e,t]}function qe(e,t){const n={apply:(r,o)=>U(r,o,{filter:i=>i.ID===o.sourceID,apply:i=>M(i,t(i.state))})};return{ID:c(),delta:n,context:e}}function N(e,t){const n={apply:(r,o)=>I(r,[t(r,o)])};return{ID:c(),delta:n,context:e}}function $e(e,t,n){return{ID:c(),context:t,delta:{apply:r=>U(r,t,{filter:o=>o.ID===e,apply:n})}}}function Fe(e,t,n){return{ID:c(),context:n,delta:{apply:r=>{const o=r.players.find(s=>s.ID===e),i=o.activeActorIDs.indexOf(null),u=o.activeActorIDs.indexOf(t);return i===-1?(console.error("NO SPACE"),r):u!==-1?(console.error("ALREADY ACTIVE"),r):(r=ee(r,n,{filter:s=>s.ID===e,apply:s=>({...s,activeActorIDs:s.activeActorIDs.map((a,f)=>f===i?t:a)})}),r=I(r,[`Activated ${P(r,t)?.name}`]),r=m(r,n,"onActorActivate"),r)}}}}function ne(e,t,n){return{ID:c(),context:n,delta:{apply:r=>{const i=r.players.find(u=>u.ID===e).activeActorIDs.indexOf(t);return i===-1?(t&&console.error("ACTOR NOT FOUND",t,e,n),r):(r=ee(r,n,{filter:u=>u.ID===e,apply:u=>({...u,activeActorIDs:u.activeActorIDs.map((s,a)=>a===i?null:s)})}),r=He(r,t),r=m(r,n,"onActorDeactivate"),r)}}}}function Ve(){return{ID:c(),context:d({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>Oe(n)).filter(n=>n.effect.duration!==0)})}}}function re(e,t){return{ID:c(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:c(),effect:e,context:r}]})}}}function x(e,t,n){return{ID:c(),context:e,delta:{apply:(r,o)=>(r=t.reduce((i,u,s)=>{const a=n[s]??o,f=p(i,a.sourceID);if(u.type==="power"&&f){if(!u.success)i=I(i,[`${f.name}'s attack missed.`]);else if(u.evade){const D=p(i,a.targetIDs[0]);i=I(i,[`${D?.name} evaded the attack.`])}}return i=Le(i,a,u),i},r),r)}}}function Ge(e){return{ID:c(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}const ze={ID:c(),delay:0,duration:1,priority:0,modifiers:H.modifiers,triggers:e=>[{ID:c(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[re(H,e)]}]},k=e=>{let t;const n=new Set,r=(f,D)=>{const v=typeof f=="function"?f(t):f;if(!Object.is(v,t)){const ce=t;t=D??(typeof v!="object"||v===null)?v:Object.assign({},t,v),n.forEach(se=>se(t,ce))}},o=()=>t,s={setState:r,getState:o,getInitialState:()=>a,subscribe:f=>(n.add(f),()=>n.delete(f))},a=t=e(r,o,s);return s},oe=(e=>e?k(e):k),Be=e=>e;function ie(e,t=Be){const n=h.useSyncExternalStore(e.subscribe,h.useCallback(()=>t(e.getState()),[e,t]),h.useCallback(()=>t(e.getInitialState()),[e,t]));return h.useDebugValue(n),n}const q=e=>Symbol.iterator in e,$=e=>"entries"in e,F=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[o,i]of n)if(!r.has(o)||!Object.is(i,r.get(o)))return!1;return!0},Ke=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let o=n.next(),i=r.next();for(;!o.done&&!i.done;){if(!Object.is(o.value,i.value))return!1;o=n.next(),i=r.next()}return!!o.done&&!!i.done};function We(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:q(e)&&q(t)?$(e)&&$(t)?F(e,t):Ke(e,t):F({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function ue(e){const t=h.useRef(void 0);return n=>{const r=e(n);return We(t.current,r)?t.current:t.current=r}}const Ye=Q({offenseStat:"intelligence",defenseStat:"intelligence",element:"psy",power:30,criticalModifier:1.5}),Je={ID:c(),name:"Brain Blast",validate:()=>!0,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>0<t.positions.length&&t.positions.length<=2},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=C(100,0,p(e,t.sourceID)),o=O(p(e,n)),i=E(Ye,r,o),u={...t,targetIDs:[n]};return x(u,[i],[u])})]},Xe={ID:c(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[],validate:()=>!0},resolve:(e,t)=>[re({ID:c(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:c(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>W(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},V=2,G=50,Ze=Q({offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5}),et={ID:c(),name:"Fireball",validate:(e,t)=>!!A(e,t.sourceID,n=>n.state.mana>=G),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>y(n,"position")),max:()=>V,validate:(e,t)=>0<t.positions.length&&t.positions.length<=V},resolve:(e,t)=>{const n=p(e,t.sourceID),r=C(100,0,n);return[qe(t,o=>({mana:o.mana-G})),x(t,t.targetIDs.map(o=>{const i=p(e,o),u=O(i);return E(Ze,r,u)}),t.targetIDs.map(o=>({...t,targetIDs:[o]})))]}},tt={ID:c(),name:"Heal",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>y(n,"position")),validate:(e,t)=>t.positions.length===1},resolve(e,t){return[$e(t.targetIDs[0],t,n=>M(n,{damage:Math.max(n.state.damage-20,0)}))]}},nt={ID:c(),name:"Hot Shots",validate:()=>!0,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>t.positions.length===1},resolve:(e,t)=>{const n=[];let r=b(80);const o=[r[1]];for(;r[0];)n.push(x(t,[Q({offenseStat:"reflexes",defenseStat:"reflexes",element:"fire",power:20})],[t])),r=b(80),o.push(r[1]);return n}},rt=Q({offenseStat:"reflexes",defenseStat:"reflexes",element:"physical",power:8,criticalModifier:1.5}),ot=50,z=8,St=10,it={ID:c(),name:"Magic Missile",validate:()=>!0,targets:{unique:!1,max:()=>z,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&g(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>t.positions.filter(n=>!!n).length===z},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=C(ot,0,p(e,t.sourceID)),o=O(p(e,n)),i=E(rt,r,o),u={...t,targetIDs:[n]};return x(u,[i],[u])})]},ut=[et,it,Je,tt,Xe,nt];function _(e,t,n){return{ID:c(),playerID:t,parentID:void 0,name:e,modified:!1,actions:ut,stats:n,state:{mana:100,damage:0,alive:1}}}const ct={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.flatMap(n=>{const r=e.actors.find(o=>o.ID===n);return[N(t,()=>`${r.name} died.`),ne(r.playerID,n,t)]})}]},st={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[Ge(t),N(t,n=>`Turn ${n.battle?.turn} started`)]}]},at={ID:c(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:c(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[Ve(),N(t,n=>`Turn ${n.battle?.turn} ended`)]}]},B=_("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),lt=_("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),ft=_("Hank","__player__",{accuracy:0,body:80,evasion:100,health:0,intelligence:100,reflexes:150,speed:150}),pt=_("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),dt=_("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),K={ID:"__player__",activeActorIDs:[null,null,null]},Dt={ID:"__ai__",activeActorIDs:[null,null,null]},gt={players:[Dt,K],battle:{turn:0,phase:"pre",effects:[{ID:c(),effect:ct,context:d({})},{ID:c(),effect:st,context:d({})},{ID:c(),effect:at,context:d({})}]},actors:[B,lt,ft,pt,dt],effects:[{ID:c(),effect:ze,context:d({playerID:K.ID,sourceID:B.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:["Combat started"]},It=oe(e=>({state:gt,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(u=>u.context.sourceID===n.sourceID))return{state:r};r=Pe(r,n,t);const i=r.players.reduce((u,s)=>u+s.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===i&&(r=T(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=Ne(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:X(t)}))},flush:()=>{e(({state:t})=>({state:Ee(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...T(t),promptQueue:[]}}))},deleteBattle:()=>{e(({state:t})=>({state:{...t,battle:void 0}}))}}));function _t(e){return ie(It,ue(e))}const mt=oe((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const o=t().playerID,i=n.actors.find(u=>u&&u.playerID===o&&g(n,u.ID)&&!n.actionQueue.find(s=>s.context.sourceID===u.ID));i&&e({activeActorID:i.ID,activeActionID:be(i,n)?.ID,stagingContext:void 0})}}));function At(e){return ie(mt,ue(e))}export{et as F,L as S,At as a,vt as b,p as c,Ze as d,V as e,it as f,De as g,St as h,rt as i,z as j,ot as k,bt as l,be as n,ht as p,_t as u,me as w};
