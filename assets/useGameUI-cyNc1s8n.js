import{R as m}from"./index-xCNo9BJ0.js";const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));function ne(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}let A;const re=new Uint8Array(16);function ie(){if(!A){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");A=crypto.getRandomValues.bind(crypto)}return A(re)}const oe=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),E={randomUUID:oe};function ue(e,t,n){e=e||{};const r=e.random??e.rng?.()??ie();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ne(r)}function u(e,t,n){return E.randomUUID&&!e?E.randomUUID():ue(e)}function ce(e){return e.stats.body}function w(e,t){return{...e,state:{...e.state,...t}}}function V(e,t){return{...e,stats:{...e.stats,...t}}}function ae(e,t){return{...e,critical:t}}function se(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],i=t.stats[n.defenseStat],o=r/i,c=n.critical?n.criticalModifier:1;return n.power*o*c}return 0}function le(e,t){return w(e,{damage:t,alive:ce(e)>t?1:0})}function fe(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(i=>{const{effect:o,context:c}=i;return o.modifiers(c).map(l=>({ID:u(),effect:o,modifier:l,context:c}))}).sort((i,o)=>i.effect.priority-o.effect.priority).reduce((i,o)=>{const{modifier:c,context:a,effect:l}=o;return c.filter&&!c.filter(i,a)?i:(n.add(l.ID),c.apply(i,a))},{...e}),e.modified=!0,[e,Array.from(n)]}const R={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:u(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>V(e,{body:e.stats.body+10})}],triggers:()=>[]};function pe(e,t){return e.players.find(i=>i.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function Dt(e,t){const n=e.actors.find(o=>o.ID===t),r=e.players.find(o=>o.ID===n?.playerID),i=r?.activeActorIDs.indexOf(t);return r?.ID&&i!==void 0&&i!==-1?{ID:u(),playerID:r.ID,index:i}:void 0}function gt(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function de(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function k(e,t){return e.actors.find(n=>n.ID===t)}function S(e,t){const n=k(e,t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return fe(n,r)[0]}function Q(e,t,n){const r=S(e,t);if(r)return n(r)}function g(e,t){return{ID:u(),type:t,target:e}}function d(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function De(e,t,n){const r=e&&e.validate(t,n);return console.log("isValid",r,e,t,n),r}function ge(e,t){return e?.actions.find(n=>De(n,t,f({sourceID:e.ID})))}function Ie(e,t){const n=t.positions.map(r=>pe(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function me(e,t){return[...e,...t]}function y(e,t){return[...t,...e]}function b(e){const[t,...n]=e;return n}function ye(e,t){return e.sort(t)}const C={ID:u(),name:"Activate",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!d(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>g(n,"targetID")),validate:(e,t)=>t.targetIDs.length===1},resolve:(e,t)=>[Y(t.playerID,t.sourceID,t),t.targetIDs.map(n=>He(t.playerID,n,t))]};function ve(e){return{...C,targets:{...C.targets,max:()=>e,validate:(t,n)=>n.targetIDs.length===e}}}function F(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=Ie(t,n);return console.log("resolving action",n,r,t),e.resolve(t,r).flatMap(i=>i)}function he(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function be(e){e=Re(e);const t=F(e.actionQueue[0].action,e,e.actionQueue[0].context),n=y(e.mutationQueue,t),r=b(e.actionQueue);return{...e,actionQueue:r,mutationQueue:n}}function _e(e){if(!e.triggerQueue[0])return e;const t=he(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=b(e.triggerQueue),r=y(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function Ae(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=b(e.mutationQueue);return{...e,mutationQueue:r}}function Se(e){switch(e){case"pre":return"start";case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"pre"}}function x(e){if(!e.battle)return e;const t=Se(e.battle.phase);return e={...e,battle:{...e.battle,phase:t}},t==="start"&&(e=D(e,f({}),"onTurnStart")),t==="end"&&(e=D(e,f({}),"onTurnEnd")),e}function G(e){if(e.triggerQueue.length>0)return _e(e);if(e.mutationQueue.length>0)return Ae(e);if(e.promptQueue.length>0)return e;const t=Oe(e);return e=t[0],t[1]?e.actionQueue.length>0?be(e):e.battle?x(e):e:e}function z(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function It(e){return e.battle?.phase==="planning"?"pending":z(e)?"running":e.promptQueue.length>0?"pending":"idle"}function Qe(e){for(;z(e);)e=G(e);return e}function f(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function xe(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function we(e){return{...e,effect:xe(e.effect)}}function K(e,t){return{...e,combatLog:[...e.combatLog,t]}}function Me(e,t,n){const r=y(e.actionQueue,[{ID:u(),action:n,context:t}]);return{...e,actionQueue:r}}function Te(e,t,n){const r=y(e.promptQueue,[{ID:u(),action:n,context:t}]);return{...e,promptQueue:r}}function Ee(e,t){if(!e.promptQueue[0])return e;const n=F(e.promptQueue[0].action,e,t),r=y(e.mutationQueue,n),i=b(e.promptQueue);return{...e,promptQueue:i,mutationQueue:r}}function D(e,t,n){const i=de(e).filter(c=>c.type===n&&c.validate(e,t)).map(c=>({ID:u(),trigger:c,context:t})),o=me(e.triggerQueue,i);return{...e,triggerQueue:o}}function Re(e){const t=ye(e.actionQueue,(n,r)=>{const i=Q(e,n.context.sourceID,c=>c.stats.speed)??0;return(Q(e,r.context.sourceID,c=>c.stats.speed)??0)-i});return{...e,actionQueue:t}}function M(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function B(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function Ce(e,t,n){let r=0;e=M(e,t,{filter:o=>t.targetIDs.includes(o.ID),apply:o=>{const c=S(e,t.sourceID),a=S(e,o.ID);if(!c||!a)return o;const l=se(c,a,n);return r+=l,le(o,o.state.damage+l)}}),r>0&&(e=D(e,t,"onDamage"));const i=e.actors.filter(o=>d(e,o.ID)&&!o.state.alive);return i.length>0&&(e=D(e,{...t,targetIDs:i.map(o=>o.ID)},"onDeath")),e}function Oe(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(i=>i.playerID===n.ID&&!n.activeActorIDs.includes(i.ID)&&i.state.alive);if(n.activeActorIDs.some(i=>i===null)&&r.length>0){const i=Math.min(r.length,n.activeActorIDs.filter(o=>o===null).length);e=Te(e,f({playerID:n.ID}),ve(i)),t=!1}}),[e,t]}function Ue(e,t){const n={apply:(r,i)=>M(r,i,{filter:o=>o.ID===i.sourceID,apply:o=>w(o,t(o.state))})};return{ID:u(),delta:n,context:e}}function W(e,t){const n={apply:(r,i)=>K(r,t)};return{ID:u(),delta:n,context:e}}function je(e,t,n){return{ID:u(),context:t,delta:{apply:r=>M(r,t,{filter:i=>i.ID===e,apply:n})}}}function He(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const i=r.players.find(a=>a.ID===e),o=i.activeActorIDs.indexOf(null),c=i.activeActorIDs.indexOf(t);return o===-1?(console.error("NO SPACE"),r):c!==-1?(console.error("ALREADY ACTIVE"),r):(r=B(r,n,{filter:a=>a.ID===e,apply:a=>({...a,activeActorIDs:a.activeActorIDs.map((l,p)=>p===o?t:l)})}),r=K(r,`Activated ${k(r,t)?.name}`),r=D(r,n,"onActorActivate"),r)}}}}function Y(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const o=r.players.find(c=>c.ID===e).activeActorIDs.indexOf(t);return o===-1?(t&&console.error("ACTOR NOT FOUND",t,e,n),r):(r=B(r,n,{filter:c=>c.ID===e,apply:c=>({...c,activeActorIDs:c.activeActorIDs.map((a,l)=>l===o?null:a)})}),r=D(r,n,"onActorDeactivate"),r)}}}}function Pe(){return{ID:u(),context:f({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>we(n)).filter(n=>n.effect.duration!==0)})}}}function $(e,t){return{ID:u(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:u(),effect:e,context:r}]})}}}function _(e,t){return{ID:u(),context:e,delta:{apply:(n,r)=>Ce(n,r,t)}}}function Le(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}function Ne(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t}}}const qe={ID:u(),delay:0,duration:1,priority:0,modifiers:R.modifiers,triggers:e=>[{ID:u(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[$(R,e)]}]},O=e=>{let t;const n=new Set,r=(p,T)=>{const I=typeof p=="function"?p(t):p;if(!Object.is(I,t)){const ee=t;t=T??(typeof I!="object"||I===null)?I:Object.assign({},t,I),n.forEach(te=>te(t,ee))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>l,subscribe:p=>(n.add(p),()=>n.delete(p))},l=t=e(r,i,a);return a},J=(e=>e?O(e):O),Ve=e=>e;function X(e,t=Ve){const n=m.useSyncExternalStore(e.subscribe,m.useCallback(()=>t(e.getState()),[e,t]),m.useCallback(()=>t(e.getInitialState()),[e,t]));return m.useDebugValue(n),n}const U=e=>Symbol.iterator in e,j=e=>"entries"in e,H=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,o]of n)if(!r.has(i)||!Object.is(o,r.get(i)))return!1;return!0},ke=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),o=r.next();for(;!i.done&&!o.done;){if(!Object.is(i.value,o.value))return!1;i=n.next(),o=r.next()}return!!i.done&&!!o.done};function Fe(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:U(e)&&U(t)?j(e)&&j(t)?H(e,t):ke(e,t):H({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function Z(e){const t=m.useRef(void 0);return n=>{const r=e(n);return Fe(t.current,r)?t.current:t.current=r}}const Ge={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",power:30,criticalModifier:1.5},ze={ID:u(),name:"Brain Blast",validate:()=>!0,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),validate:(e,t)=>0<t.positions.length&&t.positions.length<=2},resolve:(e,t)=>[t.targetIDs.map(n=>_({...t,targetIDs:[n]},Ge))]},Ke={ID:u(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[],validate:()=>!0},resolve:(e,t)=>[$({ID:u(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:u(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>V(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},P=2,L=50,Be={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5},We={ID:u(),name:"Fireball",validate:(e,t)=>!!Q(e,t.sourceID,n=>n.state.mana>=L),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),max:()=>P,validate:(e,t)=>0<t.positions.length&&t.positions.length<=P},resolve:(e,t)=>[Ue(t,n=>({mana:n.mana-L})),_(t,Be)]},Ye={ID:u(),name:"Heal",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>g(n,"position")),validate:(e,t)=>t.positions.length===1},resolve(e,t){return[je(t.targetIDs[0],t,n=>w(n,{damage:Math.max(n.state.damage-20,0)}))]}};function h(e){const t=Math.random()*100;return[t<=e,t]}const $e={ID:u(),name:"Hot Shots",validate:()=>!0,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),validate:(e,t)=>t.positions.length===1},resolve:(e,t)=>{const n=[];let r=h(80);const i=[r[1]];for(;r[0];)n.push(_(t,{type:"power",offenseStat:"reflexes",defenseStat:"reflexes",power:20,criticalModifier:1})),r=h(80),i.push(r[1]);return console.log(i),n}},Je={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"shock",power:10,criticalModifier:1.5},Xe=100,Ze=10,et={ID:u(),name:"Magic Missile",validate:()=>!0,targets:{unique:!1,max:()=>5,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),validate:(e,t)=>t.positions.filter(n=>!!n).length===5},resolve:(e,t)=>[t.targetIDs.map(n=>h(Xe)[0]?_({...t,targetIDs:[n]},ae(Je,h(Ze)[0])):Ne(t))]},tt=[We,et,ze,Ye,Ke,$e];function v(e,t,n){return{ID:u(),playerID:t,parentID:void 0,name:e,modified:!1,actions:tt,stats:n,state:{mana:100,damage:0,alive:1}}}const nt={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.map(n=>{const r=e.actors.find(i=>i.ID===n);return Y(r.playerID,n,t)})}]},rt={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[Le(t),W(t,"Turn started")]}]},it={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[Pe(),W(t,"Turn ended")]}]},N=v("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),ot=v("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),ut=v("Hank","__player__",{accuracy:0,body:80,evasion:0,health:0,intelligence:100,reflexes:150,speed:150}),ct=v("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),at=v("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),q={ID:"__player__",activeActorIDs:[null,null,null]},st={ID:"__ai__",activeActorIDs:[null,null,null]},lt={players:[st,q],battle:{turn:0,phase:"pre",effects:[{ID:u(),effect:nt,context:f({})},{ID:u(),effect:rt,context:f({})},{ID:u(),effect:it,context:f({})}]},actors:[N,ot,ut,ct,at],effects:[{ID:u(),effect:qe,context:f({playerID:q.ID,sourceID:N.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:["Combat started"]},ft=J(e=>({state:lt,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(c=>c.context.sourceID===n.sourceID))return{state:r};r=Me(r,n,t);const o=r.players.reduce((c,a)=>c+a.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===o&&(r=x(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=Ee(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:G(t)}))},flush:()=>{e(({state:t})=>({state:Qe(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...x(t),promptQueue:[]}}))}}));function mt(e){return X(ft,Z(e))}const pt=J((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const i=t().playerID,o=n.actors.find(c=>c&&c.playerID===i&&d(n,c.ID)&&!n.actionQueue.find(a=>a.context.sourceID===c.ID));o&&e({activeActorID:o.ID,activeActionID:ge(o,n)?.ID,stagingContext:void 0})}}));function yt(e){return X(pt,Z(e))}export{We as F,et as M,C as S,yt as a,Dt as b,S as c,Be as d,P as e,Ze as f,ce as g,Je as h,Xe as i,It as j,ge as n,gt as p,mt as u,fe as w};
