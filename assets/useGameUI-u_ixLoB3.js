import{R as m}from"./index-D_N55Rnp.js";const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));function te(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}let A;const ne=new Uint8Array(16);function re(){if(!A){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");A=crypto.getRandomValues.bind(crypto)}return A(ne)}const ie=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),E={randomUUID:ie};function oe(e,t,n){e=e||{};const r=e.random??e.rng?.()??re();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,te(r)}function u(e,t,n){return E.randomUUID&&!e?E.randomUUID():oe(e)}function ue(e){return e.stats.body}function w(e,t){return{...e,state:{...e.state,...t}}}function q(e,t){return{...e,stats:{...e.stats,...t}}}function ce(e,t){return{...e,critical:t}}function ae(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],i=t.stats[n.defenseStat],o=r/i,c=n.critical?n.criticalModifier:1;return n.power*o*c}return 0}function se(e,t){return w(e,{damage:t,alive:ue(e)>t?1:0})}function le(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(i=>{const{effect:o,context:c}=i;return o.modifiers(c).map(l=>({ID:u(),effect:o,modifier:l,context:c}))}).sort((i,o)=>i.effect.priority-o.effect.priority).reduce((i,o)=>{const{modifier:c,context:a,effect:l}=o;return c.filter&&!c.filter(i,a)?i:(n.add(l.ID),c.apply(i,a))},{...e}),e.modified=!0,[e,Array.from(n)]}const R={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:u(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>q(e,{body:e.stats.body+10})}],triggers:()=>[]};function fe(e,t){return e.players.find(i=>i.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function pt(e,t){const n=e.actors.find(o=>o.ID===t),r=e.players.find(o=>o.ID===n?.playerID),i=r?.activeActorIDs.indexOf(t);return r?.ID&&i!==void 0&&i!==-1?{ID:u(),playerID:r.ID,index:i}:void 0}function dt(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function pe(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function k(e,t){return e.actors.find(n=>n.ID===t)}function S(e,t){const n=k(e,t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return le(n,r)[0]}function Q(e,t,n){const r=S(e,t);if(r)return n(r)}function g(e,t){return{ID:u(),type:t,target:e}}function d(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function de(e,t){const n=t.positions.map(r=>fe(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function De(e,t){return[...e,...t]}function y(e,t){return[...t,...e]}function b(e){const[t,...n]=e;return n}function ge(e,t){return e.sort(t)}const C={ID:u(),name:"Activate",validate:(e,t)=>t.targetIDs.length===1,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!d(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>g(n,"targetID"))},resolve:(e,t)=>[W(t.playerID,t.sourceID,t),t.targetIDs.map(n=>Oe(t.playerID,n,t))]};function Ie(e){return{...C,validate:(t,n)=>n.targetIDs.length===e,targets:{...C.targets,max:()=>e}}}function F(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=de(t,n);return console.log("resolving action",n,r,t),e.resolve(t,r).flatMap(i=>i)}function me(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function ye(e){e=Me(e);const t=F(e.actionQueue[0].action,e,e.actionQueue[0].context),n=y(e.mutationQueue,t),r=b(e.actionQueue);return{...e,actionQueue:r,mutationQueue:n}}function ve(e){if(!e.triggerQueue[0])return e;const t=me(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=b(e.triggerQueue),r=y(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function he(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=b(e.mutationQueue);return{...e,mutationQueue:r}}function be(e){switch(e){case"pre":return"start";case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"pre"}}function x(e){if(!e.battle)return e;const t=be(e.battle.phase);return e={...e,battle:{...e.battle,phase:t}},t==="start"&&(e=D(e,p({}),"onTurnStart")),t==="end"&&(e=D(e,p({}),"onTurnEnd")),e}function V(e){if(e.triggerQueue.length>0)return ve(e);if(e.mutationQueue.length>0)return he(e);if(e.promptQueue.length>0)return e;const t=Ee(e);return e=t[0],t[1]?e.actionQueue.length>0?ye(e):e.battle?x(e):e:e}function G(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function Dt(e){return e.battle?.phase==="planning"?"pending":G(e)?"running":e.promptQueue.length>0?"pending":"idle"}function _e(e){for(;G(e);)e=V(e);return e}function p(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function Ae(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function Se(e){return{...e,effect:Ae(e.effect)}}function z(e,t){return{...e,combatLog:[...e.combatLog,t]}}function Qe(e,t,n){const r=y(e.actionQueue,[{ID:u(),action:n,context:t}]);return{...e,actionQueue:r}}function xe(e,t,n){const r=y(e.promptQueue,[{ID:u(),action:n,context:t}]);return{...e,promptQueue:r}}function we(e,t){if(!e.promptQueue[0])return e;const n=F(e.promptQueue[0].action,e,t),r=y(e.mutationQueue,n),i=b(e.promptQueue);return{...e,promptQueue:i,mutationQueue:r}}function D(e,t,n){const i=pe(e).filter(c=>c.type===n&&c.validate(e,t)).map(c=>({ID:u(),trigger:c,context:t})),o=De(e.triggerQueue,i);return{...e,triggerQueue:o}}function Me(e){const t=ge(e.actionQueue,(n,r)=>{const i=Q(e,n.context.sourceID,c=>c.stats.speed)??0;return(Q(e,r.context.sourceID,c=>c.stats.speed)??0)-i});return{...e,actionQueue:t}}function M(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function K(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function Te(e,t,n){let r=0;e=M(e,t,{filter:o=>t.targetIDs.includes(o.ID),apply:o=>{const c=S(e,t.sourceID),a=S(e,o.ID);if(!c||!a)return o;const l=ae(c,a,n);return r+=l,se(o,o.state.damage+l)}}),r>0&&(e=D(e,t,"onDamage"));const i=e.actors.filter(o=>d(e,o.ID)&&!o.state.alive);return i.length>0&&(e=D(e,{...t,targetIDs:i.map(o=>o.ID)},"onDeath")),e}function Ee(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(i=>i.playerID===n.ID&&!n.activeActorIDs.includes(i.ID)&&i.state.alive);if(n.activeActorIDs.some(i=>i===null)&&r.length>0){const i=Math.min(r.length,n.activeActorIDs.filter(o=>o===null).length);e=xe(e,p({playerID:n.ID}),Ie(i)),t=!1}}),[e,t]}function Re(e,t){const n={apply:(r,i)=>M(r,i,{filter:o=>o.ID===i.sourceID,apply:o=>w(o,t(o.state))})};return{ID:u(),delta:n,context:e}}function B(e,t){const n={apply:(r,i)=>z(r,t)};return{ID:u(),delta:n,context:e}}function Ce(e,t,n){return{ID:u(),context:t,delta:{apply:r=>M(r,t,{filter:i=>i.ID===e,apply:n})}}}function Oe(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const i=r.players.find(a=>a.ID===e),o=i.activeActorIDs.indexOf(null),c=i.activeActorIDs.indexOf(t);return o===-1?(console.error("NO SPACE"),r):c!==-1?(console.error("ALREADY ACTIVE"),r):(r=K(r,n,{filter:a=>a.ID===e,apply:a=>({...a,activeActorIDs:a.activeActorIDs.map((l,f)=>f===o?t:l)})}),r=z(r,`Activated ${k(r,t)?.name}`),r=D(r,n,"onActorActivate"),r)}}}}function W(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const o=r.players.find(c=>c.ID===e).activeActorIDs.indexOf(t);return o===-1?(t&&console.error("ACTOR NOT FOUND",t,e,n),r):(r=K(r,n,{filter:c=>c.ID===e,apply:c=>({...c,activeActorIDs:c.activeActorIDs.map((a,l)=>l===o?null:a)})}),r=D(r,n,"onActorDeactivate"),r)}}}}function Ue(){return{ID:u(),context:p({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>Se(n)).filter(n=>n.effect.duration!==0)})}}}function Y(e,t){return{ID:u(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:u(),effect:e,context:r}]})}}}function _(e,t){return{ID:u(),context:e,delta:{apply:(n,r)=>Te(n,r,t)}}}function je(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}function He(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t}}}const Pe={ID:u(),delay:0,duration:1,priority:0,modifiers:R.modifiers,triggers:e=>[{ID:u(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[Y(R,e)]}]},O=e=>{let t;const n=new Set,r=(f,T)=>{const I=typeof f=="function"?f(t):f;if(!Object.is(I,t)){const Z=t;t=T??(typeof I!="object"||I===null)?I:Object.assign({},t,I),n.forEach(ee=>ee(t,Z))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>l,subscribe:f=>(n.add(f),()=>n.delete(f))},l=t=e(r,i,a);return a},$=(e=>e?O(e):O),Le=e=>e;function J(e,t=Le){const n=m.useSyncExternalStore(e.subscribe,m.useCallback(()=>t(e.getState()),[e,t]),m.useCallback(()=>t(e.getInitialState()),[e,t]));return m.useDebugValue(n),n}const U=e=>Symbol.iterator in e,j=e=>"entries"in e,H=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,o]of n)if(!r.has(i)||!Object.is(o,r.get(i)))return!1;return!0},Ne=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),o=r.next();for(;!i.done&&!o.done;){if(!Object.is(i.value,o.value))return!1;i=n.next(),o=r.next()}return!!i.done&&!!o.done};function qe(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:U(e)&&U(t)?j(e)&&j(t)?H(e,t):Ne(e,t):H({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function X(e){const t=m.useRef(void 0);return n=>{const r=e(n);return qe(t.current,r)?t.current:t.current=r}}const ke={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",power:30,criticalModifier:1.5},Fe={ID:u(),name:"Brain Blast",validate:(e,t)=>0<t.positions.length&&t.positions.length<=2,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>[t.targetIDs.map(n=>_({...t,targetIDs:[n]},ke))]},Ve={ID:u(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[]},resolve:(e,t)=>[Y({ID:u(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:u(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>q(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},Ge=2,P=50,ze={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5},Ke={ID:u(),name:"Fireball",validate:(e,t)=>t.positions.length>0&&!!Q(e,t.sourceID,n=>n.state.mana>=P),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),max:()=>Ge},resolve:(e,t)=>[Re(t,n=>({mana:n.mana-P})),_(t,ze)]},Be={ID:u(),name:"Heal",validate:(e,t)=>t.positions.length===1,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>g(n,"position"))},resolve(e,t){return[Ce(t.targetIDs[0],t,n=>w(n,{damage:Math.max(n.state.damage-20,0)}))]}};function h(e){const t=Math.random()*100;return[t<=e,t]}const We={ID:u(),name:"Hot Shots",validate:(e,t)=>t.positions.length===1,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>{const n=[];let r=h(80);const i=[r[1]];for(;r[0];)n.push(_(t,{type:"power",offenseStat:"reflexes",defenseStat:"reflexes",power:20,criticalModifier:1})),r=h(80),i.push(r[1]);return console.log(i),n}},Ye={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"shock",power:10,criticalModifier:1.5},$e=100,Je=10,Xe={ID:u(),name:"Magic Missile",validate:(e,t)=>t.positions.filter(n=>!!n).length===5,targets:{unique:!1,max:()=>5,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>[t.targetIDs.map(n=>h($e)[0]?_({...t,targetIDs:[n]},ce(Ye,h(Je)[0])):He(t))]},Ze=[Ke,Xe,Fe,Be,Ve,We];function v(e,t,n){return{ID:u(),playerID:t,parentID:void 0,name:e,modified:!1,actions:Ze,stats:n,state:{mana:100,damage:0,alive:1}}}const et={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.map(n=>{const r=e.actors.find(i=>i.ID===n);return W(r.playerID,n,t)})}]},tt={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[je(t),B(t,"Turn started")]}]},nt={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[Ue(),B(t,"Turn ended")]}]},L=v("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),rt=v("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),it=v("Hank","__player__",{accuracy:0,body:80,evasion:0,health:0,intelligence:100,reflexes:150,speed:150}),ot=v("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),ut=v("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),N={ID:"__player__",activeActorIDs:[null,null,null]},ct={ID:"__ai__",activeActorIDs:[null,null,null]},at={players:[ct,N],battle:{turn:0,phase:"pre",effects:[{ID:u(),effect:et,context:p({})},{ID:u(),effect:tt,context:p({})},{ID:u(),effect:nt,context:p({})}]},actors:[L,rt,it,ot,ut],effects:[{ID:u(),effect:Pe,context:p({playerID:N.ID,sourceID:L.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:["Combat started"]},st=$(e=>({state:at,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(c=>c.context.sourceID===n.sourceID))return{state:r};r=Qe(r,n,t);const o=r.players.reduce((c,a)=>c+a.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===o&&(r=x(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=we(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:V(t)}))},flush:()=>{e(({state:t})=>({state:_e(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...x(t),promptQueue:[]}}))}}));function gt(e){return J(st,X(e))}const lt=$((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const r=t().playerID,i=n.actors.find(o=>o&&o.playerID===r&&d(n,o.ID)&&!n.actionQueue.find(c=>c.context.sourceID===o.ID));i&&e({activeActorID:i.ID,activeActionID:i.actions[0]?.ID,stagingContext:void 0})}}));function It(e){return J(lt,X(e))}export{Ke as F,Xe as M,C as S,It as a,pt as b,S as c,ze as d,Ge as e,Je as f,ue as g,Ye as h,$e as i,Dt as j,dt as p,gt as u,le as w};
