import{R as m}from"./index-B4T-EkrR.js";const s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));function Z(e,t=0){return(s[e[t+0]]+s[e[t+1]]+s[e[t+2]]+s[e[t+3]]+"-"+s[e[t+4]]+s[e[t+5]]+"-"+s[e[t+6]]+s[e[t+7]]+"-"+s[e[t+8]]+s[e[t+9]]+"-"+s[e[t+10]]+s[e[t+11]]+s[e[t+12]]+s[e[t+13]]+s[e[t+14]]+s[e[t+15]]).toLowerCase()}let S;const $=new Uint8Array(16);function ee(){if(!S){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");S=crypto.getRandomValues.bind(crypto)}return S($)}const te=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),T={randomUUID:te};function ne(e,t,n){e=e||{};const r=e.random??e.rng?.()??ee();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,Z(r)}function u(e,t,n){return T.randomUUID&&!e?T.randomUUID():ne(e)}function re(e){return e.stats.body}function w(e,t){return{...e,state:{...e.state,...t}}}function k(e,t){return{...e,stats:{...e.stats,...t}}}function ie(e,t){return{...e,critical:t}}function oe(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],i=t.stats[n.defenseStat],o=r/i,c=n.critical?n.criticalModifier:1;return n.power*o*c}return 0}function ue(e,t){return w(e,{damage:t,alive:re(e)>t?1:0})}function ce(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(i=>{const{effect:o,context:c}=i;return o.modifiers(c).map(l=>({ID:u(),effect:o,modifier:l,context:c}))}).sort((i,o)=>i.effect.priority-o.effect.priority).reduce((i,o)=>{const{modifier:c,context:a,effect:l}=o;return c.filter&&!c.filter(i,a)?i:(n.add(l.ID),c.apply(i,a))},{...e}),e.modified=!0,[e,Array.from(n)]}const R={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:u(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>k(e,{body:e.stats.body+10})}],triggers:()=>[]};function ae(e,t){return e.players.find(i=>i.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function st(e,t){const n=e.actors.find(o=>o.ID===t),r=e.players.find(o=>o.ID===n?.playerID),i=r?.activeActorIDs.indexOf(t);return r?.ID&&i!==void 0&&i!==-1?{ID:u(),playerID:r.ID,index:i}:void 0}function lt(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function se(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function A(e,t){const n=e.actors.find(i=>i.ID===t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return ce(n,r)[0]}function Q(e,t,n){const r=A(e,t);if(r)return n(r)}function g(e,t){return{ID:u(),type:t,target:e}}function d(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function le(e,t){const n=t.positions.map(r=>ae(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function fe(e,t){return[...e,...t]}function y(e,t){return[...t,...e]}function b(e){const[t,...n]=e;return n}function pe(e,t){return e.sort(t)}const O={ID:u(),name:"Activate",validate:(e,t)=>t.targetIDs.length===1,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!d(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>g(n,"targetID"))},resolve:(e,t)=>[z(t.playerID,t.sourceID,t),t.targetIDs.map(n=>Te(t.playerID,n,t))]};function de(e){return{...O,validate:(t,n)=>n.targetIDs.length===e,targets:{...O.targets,max:()=>e}}}function F(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=le(t,n);return console.log("resolving action",n,r,t),e.resolve(t,r).flatMap(i=>i)}function De(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function ge(e){e=Qe(e);const t=F(e.actionQueue[0].action,e,e.actionQueue[0].context),n=y(e.mutationQueue,t),r=b(e.actionQueue);return{...e,actionQueue:r,mutationQueue:n}}function Ie(e){if(!e.triggerQueue[0])return e;const t=De(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=b(e.triggerQueue),r=y(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function me(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=b(e.mutationQueue);return{...e,mutationQueue:r}}function ye(e){switch(e){case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"start"}}function x(e){if(!e.battle)return e;const t=ye(e.battle.phase);return e={...e,battle:{...e.battle,phase:t}},t==="start"&&(e=D(e,p({}),"onTurnStart")),t==="end"&&(e=D(e,p({}),"onTurnEnd")),e}function L(e){if(e.triggerQueue.length>0)return Ie(e);if(e.mutationQueue.length>0)return me(e);if(e.promptQueue.length>0)return e;const t=we(e);return e=t[0],t[1]?e.actionQueue.length>0?ge(e):e.battle?x(e):e:e}function V(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function ft(e){return e.battle?.phase==="planning"?"pending":V(e)?"running":e.promptQueue.length>0?"pending":"idle"}function ve(e){for(;V(e);)e=L(e);return e}function p(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function he(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function be(e){return{...e,effect:he(e.effect)}}function _e(e,t,n){const r=y(e.actionQueue,[{ID:u(),action:n,context:t}]);return{...e,actionQueue:r}}function Se(e,t,n){const r=y(e.promptQueue,[{ID:u(),action:n,context:t}]);return{...e,promptQueue:r}}function Ae(e,t){if(!e.promptQueue[0])return e;const n=F(e.promptQueue[0].action,e,t),r=y(e.mutationQueue,n),i=b(e.promptQueue);return{...e,promptQueue:i,mutationQueue:r}}function D(e,t,n){const i=se(e).filter(c=>c.type===n&&c.validate(e,t)).map(c=>({ID:u(),trigger:c,context:t})),o=fe(e.triggerQueue,i);return{...e,triggerQueue:o}}function Qe(e){const t=pe(e.actionQueue,(n,r)=>{const i=Q(e,n.context.sourceID,c=>c.stats.speed)??0;return(Q(e,r.context.sourceID,c=>c.stats.speed)??0)-i});return{...e,actionQueue:t}}function M(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function G(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function xe(e,t,n){let r=0;e=M(e,t,{filter:o=>t.targetIDs.includes(o.ID),apply:o=>{const c=A(e,t.sourceID),a=A(e,o.ID);if(!c||!a)return o;const l=oe(c,a,n);return r+=l,ue(o,o.state.damage+l)}}),r>0&&(e=D(e,t,"onDamage"));const i=e.actors.filter(o=>d(e,o.ID)&&!o.state.alive);return i.length>0&&(e=D(e,{...t,targetIDs:i.map(o=>o.ID)},"onDeath")),e}function we(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(i=>i.playerID===n.ID&&!n.activeActorIDs.includes(i.ID)&&i.state.alive);if(n.activeActorIDs.some(i=>i===null)&&r.length>0){const i=Math.min(r.length,n.activeActorIDs.filter(o=>o===null).length);e=Se(e,p({playerID:n.ID}),de(i)),t=!1}}),[e,t]}function Me(e,t){const n={apply:(r,i)=>M(r,i,{filter:o=>o.ID===i.sourceID,apply:o=>w(o,t(o.state))})};return{ID:u(),delta:n,context:e}}function Ee(e,t,n){return{ID:u(),context:t,delta:{apply:r=>M(r,t,{filter:i=>i.ID===e,apply:n})}}}function Te(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const i=r.players.find(a=>a.ID===e),o=i.activeActorIDs.indexOf(null),c=i.activeActorIDs.indexOf(t);return o===-1?(console.error("NO SPACE"),r):c!==-1?(console.error("ALREADY ACTIVE"),r):(r=G(r,n,{filter:a=>a.ID===e,apply:a=>({...a,activeActorIDs:a.activeActorIDs.map((l,f)=>f===o?t:l)})}),r=D(r,n,"onActorActivate"),r)}}}}function z(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const o=r.players.find(c=>c.ID===e).activeActorIDs.indexOf(t);return o===-1?(t&&console.error("ACTOR NOT FOUND",t),r):(r=G(r,n,{filter:c=>c.ID===e,apply:c=>({...c,activeActorIDs:c.activeActorIDs.map((a,l)=>l===o?null:a)})}),r=D(r,n,"onActorDeactivate"),r)}}}}function Re(){return{ID:u(),context:p({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>be(n)).filter(n=>n.effect.duration!==0)})}}}function K(e,t){return{ID:u(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:u(),effect:e,context:r}]})}}}function _(e,t){return{ID:u(),context:e,delta:{apply:(n,r)=>xe(n,r,t)}}}function Oe(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}function Ce(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t}}}const Ue={ID:u(),delay:0,duration:1,priority:0,modifiers:R.modifiers,triggers:e=>[{ID:u(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[K(R,e)]}]},C=e=>{let t;const n=new Set,r=(f,E)=>{const I=typeof f=="function"?f(t):f;if(!Object.is(I,t)){const J=t;t=E??(typeof I!="object"||I===null)?I:Object.assign({},t,I),n.forEach(X=>X(t,J))}},i=()=>t,a={setState:r,getState:i,getInitialState:()=>l,subscribe:f=>(n.add(f),()=>n.delete(f))},l=t=e(r,i,a);return a},B=(e=>e?C(e):C),je=e=>e;function W(e,t=je){const n=m.useSyncExternalStore(e.subscribe,m.useCallback(()=>t(e.getState()),[e,t]),m.useCallback(()=>t(e.getInitialState()),[e,t]));return m.useDebugValue(n),n}const U=e=>Symbol.iterator in e,j=e=>"entries"in e,H=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,o]of n)if(!r.has(i)||!Object.is(o,r.get(i)))return!1;return!0},He=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),o=r.next();for(;!i.done&&!o.done;){if(!Object.is(i.value,o.value))return!1;i=n.next(),o=r.next()}return!!i.done&&!!o.done};function Pe(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:U(e)&&U(t)?j(e)&&j(t)?H(e,t):He(e,t):H({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function Y(e){const t=m.useRef(void 0);return n=>{const r=e(n);return Pe(t.current,r)?t.current:t.current=r}}const Ne={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",power:30,criticalModifier:1.5},qe={ID:u(),name:"Brain Blast",validate:(e,t)=>0<t.positions.length&&t.positions.length<=2,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>[t.targetIDs.map(n=>_({...t,targetIDs:[n]},Ne))]},ke={ID:u(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[]},resolve:(e,t)=>[K({ID:u(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:u(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>k(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},Fe=2,P=50,Le={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5},Ve={ID:u(),name:"Fireball",validate:(e,t)=>t.positions.length>0&&!!Q(e,t.sourceID,n=>n.state.mana>=P),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position")),max:()=>Fe},resolve:(e,t)=>[Me(t,n=>({mana:n.mana-P})),_(t,Le)]},Ge={ID:u(),name:"Heal",validate:(e,t)=>t.positions.length===1,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>g(n,"position"))},resolve(e,t){return[Ee(t.targetIDs[0],t,n=>w(n,{damage:Math.max(n.state.damage-20,0)}))]}};function h(e){const t=Math.random()*100;return[t<=e,t]}const ze={ID:u(),name:"Hot Shots",validate:(e,t)=>t.positions.length===1,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>{const n=[];let r=h(80);const i=[r[1]];for(;r[0];)n.push(_(t,{type:"power",offenseStat:"reflexes",defenseStat:"reflexes",power:20,criticalModifier:1})),r=h(80),i.push(r[1]);return console.log(i),n}},Ke={type:"power",offenseStat:"intelligence",defenseStat:"intelligence",element:"shock",power:10,criticalModifier:1.5},Be=100,We=10,Ye={ID:u(),name:"Magic Missile",validate:(e,t)=>t.positions.filter(n=>!!n).length===5,targets:{unique:!1,max:()=>5,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&d(e,n.ID)).map(n=>g(n,"position"))},resolve:(e,t)=>[t.targetIDs.map(n=>h(Be)[0]?_({...t,targetIDs:[n]},ie(Ke,h(We)[0])):Ce(t))]},Je=[Ve,Ye,qe,Ge,ke,ze];function v(e,t,n){return{ID:u(),playerID:t,parentID:void 0,name:e,modified:!1,actions:Je,stats:n,state:{mana:100,damage:0,alive:1}}}const Xe={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.map(n=>z(t.playerID,n,t))}]},Ze={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[Oe(t)]}]},$e={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[Re()]}]},N=v("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),et=v("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),tt=v("Hank","__player__",{accuracy:0,body:80,evasion:0,health:0,intelligence:100,reflexes:150,speed:150}),nt=v("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),rt=v("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),q={ID:"__player__",activeActorIDs:[null,null,null]},it={ID:"__ai__",activeActorIDs:[null,null,null]},ot={players:[it,q],battle:{turn:0,phase:"start",effects:[{ID:u(),effect:Xe,context:p({})},{ID:u(),effect:Ze,context:p({})},{ID:u(),effect:$e,context:p({})}]},actors:[N,et,tt,nt,rt],effects:[{ID:u(),effect:Ue,context:p({playerID:q.ID,sourceID:N.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:[]},ut=B(e=>({state:ot,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(c=>c.context.sourceID===n.sourceID))return{state:r};r=_e(r,n,t);const o=r.players.reduce((c,a)=>c+a.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===o&&(r=x(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=Ae(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:L(t)}))},flush:()=>{e(({state:t})=>({state:ve(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...x(t),promptQueue:[]}}))}}));function pt(e){return W(ut,Y(e))}const ct=B((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const r=t().playerID,i=n.actors.find(o=>o&&o.playerID===r&&d(n,o.ID)&&!n.actionQueue.find(c=>c.context.sourceID===o.ID));i&&e({activeActorID:i.ID,activeActionID:i.actions[0]?.ID,stagingContext:void 0})}}));function dt(e){return W(ct,Y(e))}export{Ve as F,Ye as M,O as S,dt as a,st as b,A as c,Le as d,Fe as e,We as f,re as g,Ke as h,Be as i,ft as j,lt as p,pt as u,ce as w};
