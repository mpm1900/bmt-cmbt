import{R as h}from"./index-DR1PX_u8.js";const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function ue(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let x;const se=new Uint8Array(16);function ae(){if(!x){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");x=crypto.getRandomValues.bind(crypto)}return x(se)}const le=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),P={randomUUID:le};function fe(e,t,n){e=e||{};const r=e.random??e.rng?.()??ae();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,ue(r)}function u(e,t,n){return P.randomUUID&&!e?P.randomUUID():fe(e)}function b(e){const t=Math.random()*100;return[t<=e,t]}function de(e){return e.stats.body}function T(e,t){return{...e,state:{...e.state,...t}}}function B(e,t){return{...e,stats:{...e.stats,...t}}}function Q(e){return{type:"power",success:!1,evade:!1,critical:!1,criticalModifier:1,element:"physical",...e}}function W(e){return{success:!1,successRoll:0,successThreshold:0,critical:!1,criticalRoll:0,criticalThreshold:0,...e}}function E(e,t,n){return{...e,success:t.success,evade:n.success,critical:t.success&&t.critical}}function C(e,t,n){const r=e+n.stats.accuracy,i=b(r),o=t+0,c=b(o);return W({success:i[0],successRoll:i[1],successThreshold:r,critical:c[0],criticalRoll:c[1],criticalThreshold:o})}function O(e){const t=b(e.stats.evasion);return W({success:t[0],successRoll:t[1],successThreshold:e.stats.evasion})}function pe(e,t,n){if(n.type==="raw")return n.raw;if(n.type==="power"){const r=e.stats[n.offenseStat],i=t.stats[n.defenseStat],o=r/i,c=n.success?1:0,s=n.critical?n.criticalModifier:1,a=n.evade?0:1;return Math.round(n.power*o*c*s*a)}return 0}function ge(e,t){return T(e,{damage:t,alive:de(e)>t?1:0})}function De(e,t){if(e.modified)return console.error("already modified",e,t),[e,[]];const n=new Set;return e=t.flatMap(i=>{const{effect:o,context:c}=i;return o.modifiers(c).map(a=>({ID:u(),effect:o,modifier:a,context:c}))}).sort((i,o)=>i.effect.priority-o.effect.priority).reduce((i,o)=>{const{modifier:c,context:s,effect:a}=o;return c.filter&&!c.filter(i,s)?i:(n.add(a.ID),c.apply(i,s))},{...e}),e.modified=!0,[e,Array.from(n)]}const L={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[{ID:u(),filter:(e,t)=>e.ID===t.sourceID,apply:e=>B(e,{body:e.stats.body+10})}],triggers:()=>[]};function Ie(e,t){return e.players.find(i=>i.ID===t.playerID)?.activeActorIDs[t.index]??void 0}function mt(e,t){const n=e.actors.find(o=>o.ID===t),r=e.players.find(o=>o.ID===n?.playerID),i=r?.activeActorIDs.indexOf(t);return r?.ID&&i!==void 0&&i!==-1?{ID:u(),playerID:r.ID,index:i}:void 0}function yt(e,t){return e?.playerID===t?.playerID&&e?.index===t?.index}function me(e){return[...e.effects,...e.battle?.effects??[]].flatMap(({effect:n,context:r})=>n.triggers(r))}function U(e,t){return e.actors.find(n=>n.ID===t)}function d(e,t){const n=U(e,t);if(!n)return;const r=[...e.effects,...e.battle?.effects??[]];return De(n,r)[0]}function S(e,t,n){const r=d(e,t);if(r)return n(r)}function y(e,t){return{ID:u(),type:t,target:e}}function D(e,t){return e.players.some(n=>n.activeActorIDs.includes(t))}function ye(e,t,n){return e&&e.validate(t,n)}function ve(e,t){return e?.actions.find(n=>ye(n,t,p({sourceID:e.ID})))}function he(e,t){const n=t.positions.map(r=>Ie(e,r));return{playerID:t.playerID,sourceID:t.sourceID,targetIDs:n.filter(r=>r!==void 0).concat(t.targetIDs)}}function be(e,t){return[...e,...t]}function _(e,t){return[...t,...e]}function w(e){const[t,...n]=e;return n}function _e(e,t){return e.sort(t)}const k={ID:u(),name:"Activate",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.filter(n=>!D(e,n.ID)&&n.playerID==t.playerID&&n.state.alive).map(n=>y(n,"targetID")),validate:(e,t)=>t.targetIDs.length===1},resolve:(e,t)=>[ee(t.playerID,t.sourceID,t),t.targetIDs.map(n=>Ne(t.playerID,n,t))]};function Ae(e){return{...k,targets:{...k.targets,max:()=>e,validate:(t,n)=>n.targetIDs.length===e}}}function Y(e,t,n){if(!e.validate(t,n))return console.error("resolver validation failed",e,t,n),[];const r=he(t,n);return e.resolve(t,r).flatMap(i=>i)}function Se(e,t,n){return e.validate(t,n)?e.resolve(t,n).flatMap(r=>r):(console.error("resolver validation failed",e,t,n),[])}function Qe(e){e=je(e);const t=e.actionQueue[0];e=I(e,[`${S(e,t.context.sourceID,o=>o.name)} uses ${t.action.name}.`]);const n=Y(t.action,e,t.context),r=_(e.mutationQueue,n),i=w(e.actionQueue);return{...e,actionQueue:i,mutationQueue:r}}function we(e){if(!e.triggerQueue[0])return e;const t=Se(e.triggerQueue[0].trigger,e,e.triggerQueue[0].context),n=w(e.triggerQueue),r=_(e.mutationQueue,t);return{...e,mutationQueue:r,triggerQueue:n}}function Me(e){if(!e.mutationQueue[0])return e;const{delta:t,context:n}=e.mutationQueue[0];if(t.filter&&!t.filter(e,n))return e;e=e.mutationQueue[0].delta.apply(e,e.mutationQueue[0].context);const r=w(e.mutationQueue);return{...e,mutationQueue:r}}function xe(e){switch(e){case"pre":return"start";case"start":return"planning";case"planning":return"main";case"main":return"end";case"end":return"start";default:return"pre"}}function R(e){if(!e.battle)return e;const t=xe(e.battle.phase);return e={...e,battle:{...e.battle,phase:t}},t==="start"&&(e=m(e,p({}),"onTurnStart")),t==="end"&&(e=m(e,p({}),"onTurnEnd")),e}function J(e){if(e.triggerQueue.length>0)return we(e);if(e.mutationQueue.length>0)return Me(e);if(e.promptQueue.length>0)return e;const t=Le(e);return e=t[0],t[1]?e.actionQueue.length>0?Qe(e):e.battle?R(e):e:e}function X(e){return e.mutationQueue.length>0||e.triggerQueue.length>0||e.actionQueue.length>0&&e.promptQueue.length===0}function vt(e){return e.battle?.phase==="planning"?"pending":X(e)?"running":e.promptQueue.length>0?"pending":"idle"}function Re(e){for(;X(e);)e=J(e);return e}function p(e){return{playerID:"",sourceID:"",targetIDs:[],positions:[],...e}}function Te(e){return{...e,duration:e.duration===void 0?void 0:e.duration-1}}function Ee(e){return{...e,effect:Te(e.effect)}}function I(e,t){return{...e,combatLog:[...e.combatLog,...t]}}function Ce(e,t,n){const r=_(e.actionQueue,[{ID:u(),action:n,context:t}]);return{...e,actionQueue:r}}function Oe(e,t,n){const r=_(e.promptQueue,[{ID:u(),action:n,context:t}]);return{...e,promptQueue:r}}function Ue(e,t){if(!e.promptQueue[0])return e;const n=Y(e.promptQueue[0].action,e,t),r=_(e.mutationQueue,n),i=w(e.promptQueue);return{...e,promptQueue:i,mutationQueue:r}}function m(e,t,n){const i=me(e).filter(c=>c.type===n&&c.validate(e,t)).map(c=>({ID:u(),trigger:c,context:t})),o=be(e.triggerQueue,i);return{...e,triggerQueue:o}}function je(e){const t=_e(e.actionQueue,(n,r)=>{const i=S(e,n.context.sourceID,c=>c.stats.speed)??0;return(S(e,r.context.sourceID,c=>c.stats.speed)??0)-i});return{...e,actionQueue:t}}function He(e,t){const n=e.actionQueue.filter(r=>r.context.sourceID!==t);return console.log("filtering action queue",t),console.log(e.actionQueue),console.log(n),{...e,actionQueue:n}}function j(e,t,n){return{...e,actors:e.actors.map(r=>!r.state.alive||n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function Z(e,t,n){return{...e,players:e.players.map(r=>n.filter&&!n.filter(r,t)?r:n.apply(r,t))}}function Pe(e,t,n){let r=0;e=j(e,t,{filter:s=>t.targetIDs.includes(s.ID),apply:s=>{const a=d(e,t.sourceID),f=d(e,s.ID);if(!a||!f)return s;const g=pe(a,f,n);return r+=g,ge(s,s.state.damage+g)}});const i=t.targetIDs[0],o=U(e,i),c=D(e,i)&&!o?.state.alive;return r>0&&(e=m(e,t,"onDamage"),e=I(e,[`${o?.name} took ${r} damage.`])),c&&(e=m(e,t,"onDeath")),e}function Le(e){let t=!0;return e.players.forEach(n=>{const r=e.actors.filter(i=>i.playerID===n.ID&&!n.activeActorIDs.includes(i.ID)&&i.state.alive);if(n.activeActorIDs.some(i=>i===null)&&r.length>0){const i=Math.min(r.length,n.activeActorIDs.filter(o=>o===null).length);e=Oe(e,p({playerID:n.ID}),Ae(i)),t=!1}}),[e,t]}function ke(e,t){const n={apply:(r,i)=>j(r,i,{filter:o=>o.ID===i.sourceID,apply:o=>T(o,t(o.state))})};return{ID:u(),delta:n,context:e}}function H(e,t){const n={apply:(r,i)=>I(r,[t(r,i)])};return{ID:u(),delta:n,context:e}}function qe(e,t,n){return{ID:u(),context:t,delta:{apply:r=>j(r,t,{filter:i=>i.ID===e,apply:n})}}}function Ne(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const i=r.players.find(s=>s.ID===e),o=i.activeActorIDs.indexOf(null),c=i.activeActorIDs.indexOf(t);return o===-1?(console.error("NO SPACE"),r):c!==-1?(console.error("ALREADY ACTIVE"),r):(r=Z(r,n,{filter:s=>s.ID===e,apply:s=>({...s,activeActorIDs:s.activeActorIDs.map((a,f)=>f===o?t:a)})}),r=I(r,[`Activated ${U(r,t)?.name}`]),r=m(r,n,"onActorActivate"),r)}}}}function ee(e,t,n){return{ID:u(),context:n,delta:{apply:r=>{const o=r.players.find(c=>c.ID===e).activeActorIDs.indexOf(t);return o===-1?(t&&console.error("ACTOR NOT FOUND",t,e,n),r):(r=Z(r,n,{filter:c=>c.ID===e,apply:c=>({...c,activeActorIDs:c.activeActorIDs.map((s,a)=>a===o?null:s)})}),r=He(r,t),r=m(r,n,"onActorDeactivate"),r)}}}}function $e(){return{ID:u(),context:p({}),delta:{apply:(e,t)=>({...e,effects:e.effects.map(n=>Ee(n)).filter(n=>n.effect.duration!==0)})}}}function te(e,t){return{ID:u(),context:t,delta:{apply:(n,r)=>({...n,effects:[...n.effects,{ID:u(),effect:e,context:r}]})}}}function M(e,t,n){return{ID:u(),context:e,delta:{apply:(r,i)=>(r=t.reduce((o,c,s)=>{const a=n[s]??i,f=d(o,a.sourceID);if(c.type==="power"&&f&&(c.success||(o=I(o,[`${f.name}'s attack missed.`])),c.evade)){const g=d(o,a.targetIDs[0]);o=I(o,[`${g?.name} evaded the attack.`])}return o=Pe(o,a,c),o},r),r)}}}function Fe(e){return{ID:u(),context:e,delta:{apply:(t,n)=>t.battle?{...t,battle:{...t.battle,turn:t.battle.turn+1}}:t}}}const Ve={ID:u(),delay:0,duration:1,priority:0,modifiers:L.modifiers,triggers:e=>[{ID:u(),type:"onDamage",validate:(t,n)=>n.targetIDs.includes(e.sourceID),resolve:(t,n)=>[te(L,e)]}]},q=e=>{let t;const n=new Set,r=(f,g)=>{const v=typeof f=="function"?f(t):f;if(!Object.is(v,t)){const oe=t;t=g??(typeof v!="object"||v===null)?v:Object.assign({},t,v),n.forEach(ce=>ce(t,oe))}},i=()=>t,s={setState:r,getState:i,getInitialState:()=>a,subscribe:f=>(n.add(f),()=>n.delete(f))},a=t=e(r,i,s);return s},ne=(e=>e?q(e):q),Ge=e=>e;function re(e,t=Ge){const n=h.useSyncExternalStore(e.subscribe,h.useCallback(()=>t(e.getState()),[e,t]),h.useCallback(()=>t(e.getInitialState()),[e,t]));return h.useDebugValue(n),n}const N=e=>Symbol.iterator in e,$=e=>"entries"in e,F=(e,t)=>{const n=e instanceof Map?e:new Map(e.entries()),r=t instanceof Map?t:new Map(t.entries());if(n.size!==r.size)return!1;for(const[i,o]of n)if(!r.has(i)||!Object.is(o,r.get(i)))return!1;return!0},ze=(e,t)=>{const n=e[Symbol.iterator](),r=t[Symbol.iterator]();let i=n.next(),o=r.next();for(;!i.done&&!o.done;){if(!Object.is(i.value,o.value))return!1;i=n.next(),o=r.next()}return!!i.done&&!!o.done};function Ke(e,t){return Object.is(e,t)?!0:typeof e!="object"||e===null||typeof t!="object"||t===null||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t)?!1:N(e)&&N(t)?$(e)&&$(t)?F(e,t):ze(e,t):F({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}function ie(e){const t=h.useRef(void 0);return n=>{const r=e(n);return Ke(t.current,r)?t.current:t.current=r}}const Be=Q({offenseStat:"intelligence",defenseStat:"intelligence",element:"psy",power:30,criticalModifier:1.5}),We={ID:u(),name:"Brain Blast",validate:()=>!0,targets:{unique:!0,max:()=>2,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&D(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>0<t.positions.length&&t.positions.length<=2},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=C(100,0,d(e,t.sourceID)),i=O(d(e,n)),o=E(Be,r,i),c={...t,targetIDs:[n]};return M(c,[o],[c])})]},Ye={ID:u(),name:"Dragon Dance",validate:()=>!0,targets:{unique:!0,max:()=>0,get:()=>[],validate:()=>!0},resolve:(e,t)=>[te({ID:u(),delay:0,duration:void 0,priority:0,triggers:()=>[],modifiers:()=>[{ID:u(),filter:(n,r)=>n.ID===r.sourceID,apply:n=>B(n,{body:n.stats.body*1.5})}]},{playerID:t.playerID,sourceID:t.sourceID,targetIDs:[t.sourceID]})]},V=2,G=50,Je=Q({offenseStat:"intelligence",defenseStat:"intelligence",element:"fire",power:50,criticalModifier:1.5}),Xe={ID:u(),name:"Fireball",validate:(e,t)=>!!S(e,t.sourceID,n=>n.state.mana>=G),targets:{unique:!0,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&D(e,n.ID)).map(n=>y(n,"position")),max:()=>V,validate:(e,t)=>0<t.positions.length&&t.positions.length<=V},resolve:(e,t)=>{const n=d(e,t.sourceID),r=C(100,0,n);return[ke(t,i=>({mana:i.mana-G})),M(t,t.targetIDs.map(i=>{const o=d(e,i),c=O(o);return E(Je,r,c)}),t.targetIDs.map(i=>({...t,targetIDs:[i]})))]}},Ze={ID:u(),name:"Heal",validate:()=>!0,targets:{unique:!0,max:()=>1,get:(e,t)=>e.actors.map(n=>y(n,"position")),validate:(e,t)=>t.positions.length===1},resolve(e,t){return[qe(t.targetIDs[0],t,n=>T(n,{damage:Math.max(n.state.damage-20,0)}))]}},et={ID:u(),name:"Hot Shots",validate:()=>!0,targets:{unique:!1,max:()=>1,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&D(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>t.positions.length===1},resolve:(e,t)=>{const n=[];let r=b(80);const i=[r[1]];for(;r[0];)n.push(M(t,[Q({offenseStat:"reflexes",defenseStat:"reflexes",element:"fire",power:20})],[t])),r=b(80),i.push(r[1]);return n}},tt=Q({offenseStat:"intelligence",defenseStat:"intelligence",element:"shock",power:10,criticalModifier:1.5}),nt=50,ht=10,rt={ID:u(),name:"Magic Missile",validate:()=>!0,targets:{unique:!1,max:()=>5,get:(e,t)=>e.actors.filter(n=>n.ID!==t.sourceID&&D(e,n.ID)).map(n=>y(n,"position")),validate:(e,t)=>t.positions.filter(n=>!!n).length===5},resolve:(e,t)=>[t.targetIDs.map(n=>{const r=C(nt,0,d(e,t.sourceID)),i=O(d(e,n)),o=E(tt,r,i),c={...t,targetIDs:[n]};return M(c,[o],[c])})]},it=[Xe,rt,We,Ze,Ye,et];function A(e,t,n){return{ID:u(),playerID:t,parentID:void 0,name:e,modified:!1,actions:it,stats:n,state:{mana:100,damage:0,alive:1}}}const ot={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onDeath",validate:()=>!0,resolve:(e,t)=>t.targetIDs.flatMap(n=>{const r=e.actors.find(i=>i.ID===n);return[H(t,()=>`${r.name} died.`),ee(r.playerID,n,t)]})}]},ct={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnStart",validate:()=>!0,resolve:(e,t)=>[Fe(t),H(t,n=>`Turn ${n.battle?.turn} started`)]}]},ut={ID:u(),delay:0,duration:void 0,priority:0,modifiers:()=>[],triggers:()=>[{ID:u(),type:"onTurnEnd",validate:()=>!0,resolve:(e,t)=>[$e(),H(t,n=>`Turn ${n.battle?.turn} ended`)]}]},z=A("Max","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:100,speed:100}),st=A("Katie","__player__",{accuracy:0,body:100,evasion:0,health:0,reflexes:100,intelligence:180,speed:70}),at=A("Hank","__player__",{accuracy:0,body:80,evasion:100,health:0,intelligence:100,reflexes:150,speed:150}),lt=A("Milo","__player__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),ft=A("Criminal","__ai__",{accuracy:0,body:100,evasion:0,health:0,intelligence:100,reflexes:100,speed:100}),K={ID:"__player__",activeActorIDs:[null,null,null]},dt={ID:"__ai__",activeActorIDs:[null,null,null]},pt={players:[dt,K],battle:{turn:0,phase:"pre",effects:[{ID:u(),effect:ot,context:p({})},{ID:u(),effect:ct,context:p({})},{ID:u(),effect:ut,context:p({})}]},actors:[z,st,at,lt,ft],effects:[{ID:u(),effect:Ve,context:p({playerID:K.ID,sourceID:z.ID})}],actionQueue:[],promptQueue:[],triggerQueue:[],mutationQueue:[],combatLog:["Combat started"]},gt=ne(e=>({state:pt,pushAction:(t,n)=>{e(({state:r})=>{if(r.actionQueue.find(c=>c.context.sourceID===n.sourceID))return{state:r};r=Ce(r,n,t);const o=r.players.reduce((c,s)=>c+s.activeActorIDs.filter(Boolean).length,0);return r.actionQueue.length===o&&(r=R(r)),{state:r}})},resolvePrompt:t=>{e(({state:n})=>(n=Ue(n,t),{state:n}))},next:()=>{e(({state:t})=>({state:J(t)}))},flush:()=>{e(({state:t})=>({state:Re(t)}))},nextPhase:()=>{e(({state:t})=>({state:{...R(t),promptQueue:[]}}))}}));function bt(e){return re(gt,ie(e))}const Dt=ne((e,t)=>({playerID:"__player__",view:"actions",activeActorID:void 0,activeActionID:void 0,stagingContext:void 0,set:n=>e(n),resetActive:n=>{const i=t().playerID,o=n.actors.find(c=>c&&c.playerID===i&&D(n,c.ID)&&!n.actionQueue.find(s=>s.context.sourceID===c.ID));o&&e({activeActorID:o.ID,activeActionID:ve(o,n)?.ID,stagingContext:void 0})}}));function _t(e){return re(Dt,ie(e))}export{Xe as F,rt as M,k as S,_t as a,mt as b,d as c,Je as d,V as e,ht as f,de as g,tt as h,nt as i,vt as j,ve as n,yt as p,bt as u,De as w};
